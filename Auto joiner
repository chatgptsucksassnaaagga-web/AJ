-- =====================================
-- KRYPTH GUI LOGIC (AUTO JOINER)
-- =====================================

repeat task.wait() until game:IsLoaded()

-- SERVICES
local Players = game:GetService("Players")
local TeleportService = game:GetService("TeleportService")
local HttpService = game:GetService("HttpService")

local PLAYER = Players.LocalPlayer
local RELAY_URL = "https://introducing-annual-sys-oops.trycloudflare.com/servers"

-- GUI REFERENCES
local Gui = PLAYER.PlayerGui:WaitForChild("Krypth ")
local JoinBtn = Gui:WaitForChild("KRYPTH JOIN BUTTON")
local SettingsBtn = Gui:WaitForChild("KRYPTH SETTINGS")
local SettingsFrame = SettingsBtn:WaitForChild("Krypth settings frame")
local InputBox = SettingsFrame:WaitForChild("Krypth Setting textbox")

-- STATE
local MIN_MPS = 0
SettingsFrame.Visible = false

-- ============================
-- SETTINGS TOGGLE
-- ============================
SettingsBtn.MouseButton1Click:Connect(function()
	SettingsFrame.Visible = not SettingsFrame.Visible
end)

-- ============================
-- INPUT HANDLING
-- ============================
InputBox:GetPropertyChangedSignal("Text"):Connect(function()
	local n = tonumber(InputBox.Text:gsub("%D", ""))
	if n then
		MIN_MPS = n
	end
end)

-- ============================
-- GET BEST SERVER
-- ============================
local function getBestServer()
	local ok, raw = pcall(function()
		return HttpService:GetAsync(RELAY_URL)
	end)
	if not ok then return end

	local data
	ok, data = pcall(function()
		return HttpService:JSONDecode(raw)
	end)
	if not ok or type(data) ~= "table" then return end

	local best
	for _, s in ipairs(data) do
		local mps = tonumber(s.mps) or 0
		if mps >= MIN_MPS then
			if not best or mps > best.mps then
				best = s
			end
		end
	end

	return best
end

-- ============================
-- JOIN BUTTON
-- ============================
JoinBtn.MouseButton1Click:Connect(function()
	local best = getBestServer()
	if best and best.placeId and best.jobId then
		TeleportService:TeleportToPlaceInstance(
			best.placeId,
			best.jobId,
			PLAYER
		)
	end
end)
