repeat task.wait() until game:IsLoaded()

-- SERVICES
local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local HttpService = game:GetService("HttpService")
local TeleportService = game:GetService("TeleportService")
local CoreGui = game:GetService("CoreGui")

local Player = Players.LocalPlayer

-- CONFIG
local RELAY_URL = "https://subcommittee-resort-victor-retail.trycloudflare.com/servers"

-- FONT
local FONT = Font.new("rbxasset://fonts/families/TitilliumWeb.json")

-- CLEANUP
pcall(function()
	if CoreGui:FindFirstChild("KrypthAJ") then
		CoreGui.KrypthAJ:Destroy()
	end
end)

-- =========================
-- GUI ROOT
-- =========================
local Gui = Instance.new("ScreenGui")
Gui.Name = "KrypthAJ"
Gui.ResetOnSpawn = false
Gui.Parent = CoreGui

-- =========================
-- MAIN BAR (TOP CENTER)
-- =========================
local Bar = Instance.new("Frame")
Bar.Size = UDim2.fromOffset(420, 48)
Bar.Position = UDim2.fromScale(0.5, 0.06)
Bar.AnchorPoint = Vector2.new(0.5, 0)
Bar.BackgroundColor3 = Color3.fromRGB(18, 18, 24)
Bar.BorderSizePixel = 0
Bar.Parent = Gui
Instance.new("UICorner", Bar).CornerRadius = UDim.new(0, 14)

-- DRAG
do
	local dragging, dragStart, startPos
	Bar.InputBegan:Connect(function(i)
		if i.UserInputType == Enum.UserInputType.MouseButton1 then
			dragging = true
			dragStart = i.Position
			startPos = Bar.Position
		end
	end)
	Bar.InputEnded:Connect(function(i)
		if i.UserInputType == Enum.UserInputType.MouseButton1 then
			dragging = false
		end
	end)
	game:GetService("UserInputService").InputChanged:Connect(function(i)
		if dragging and i.UserInputType == Enum.UserInputType.MouseMovement then
			local delta = i.Position - dragStart
			Bar.Position = startPos + UDim2.fromOffset(delta.X, delta.Y)
		end
	end)
end

-- =========================
-- BUTTONS
-- =========================
local function makeButton(text, x)
	local b = Instance.new("TextButton")
	b.Size = UDim2.fromOffset(160, 32)
	b.Position = UDim2.fromOffset(x, 8)
	b.Text = text
	b.FontFace = FONT
	b.TextSize = 15
	b.TextColor3 = Color3.fromRGB(235,235,245)
	b.BackgroundColor3 = Color3.fromRGB(32,32,40)
	b.BorderSizePixel = 0
	b.Parent = Bar
	Instance.new("UICorner", b).CornerRadius = UDim.new(0, 10)
	return b
end

local AJButton = makeButton("Krypth AJ", 16)
local SettingsButton = makeButton("Settings", 244)

-- =========================
-- SETTINGS PANEL
-- =========================
local Settings = Instance.new("Frame")
Settings.Size = UDim2.fromOffset(420, 140)
Settings.Position = UDim2.fromScale(0.5, 0.06)
Settings.AnchorPoint = Vector2.new(0.5, 0)
Settings.BackgroundColor3 = Color3.fromRGB(22,22,28)
Settings.BorderSizePixel = 0
Settings.Visible = false
Settings.Parent = Gui
Instance.new("UICorner", Settings).CornerRadius = UDim.new(0, 14)

-- INPUT
local Input = Instance.new("TextBox")
Input.Size = UDim2.fromOffset(200, 36)
Input.Position = UDim2.fromOffset(20, 60)
Input.PlaceholderText = "Enter money (e.g. 49000000)"
Input.Text = ""
Input.FontFace = FONT
Input.TextSize = 14
Input.TextColor3 = Color3.fromRGB(230,230,240)
Input.BackgroundColor3 = Color3.fromRGB(32,32,40)
Input.BorderSizePixel = 0
Input.Parent = Settings
Instance.new("UICorner", Input).CornerRadius = UDim.new(0, 10)

-- DISPLAY (49)
local Display = Instance.new("TextLabel")
Display.Size = UDim2.fromOffset(120, 36)
Display.Position = UDim2.fromOffset(260, 60)
Display.Text = "0"
Display.FontFace = FONT
Display.TextSize = 18
Display.TextColor3 = Color3.fromRGB(120,200,255)
Display.BackgroundTransparency = 1
Display.Parent = Settings

local MinMPS = 0

Input:GetPropertyChangedSignal("Text"):Connect(function()
	local n = tonumber(Input.Text)
	if n then
		MinMPS = n
		Display.Text = tostring(math.floor(n / 1_000_000))
	end
end)

-- TOGGLE SETTINGS
SettingsButton.MouseButton1Click:Connect(function()
	Settings.Visible = not Settings.Visible
end)

-- =========================
-- FETCH + JOIN LOGIC
-- =========================
local function getBestServer()
	local ok, body = pcall(function()
		return HttpService:GetAsync(RELAY_URL)
	end)
	if not ok then return nil end

	local data = HttpService:JSONDecode(body)
	local best

	for _,s in ipairs(data) do
		local mps = tonumber(
			(type(s.money) == "string" and s.money:gsub("[^%d]", "")) or s.mps
		) or 0

		if mps >= MinMPS then
			if not best or mps > best.mps then
				best = {
					jobId = s.jobId,
					placeId = s.placeId,
					mps = mps
				}
			end
		end
	end

	return best
end

AJButton.MouseButton1Click:Connect(function()
	local best = getBestServer()
	if best then
		TeleportService:TeleportToPlaceInstance(best.placeId, best.jobId, Player)
	end
end)
